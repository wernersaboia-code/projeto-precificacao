<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precifica√ß√£o Simples</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: white;
            color: #667eea;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        button:hover {
            background: #5568d3;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .btn-expand {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
        }

        .btn-expand:hover {
            background: #2980b9;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .details-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .detail-item {
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .detail-item label {
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: #666;
        }

        .detail-item .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .dashboard-card h3 {
            color: #667eea;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .dashboard-card .value {
            color: #333;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .dashboard-card .status {
            color: #28a745;
            font-size: 1rem;
            margin-top: 10px;
        }

        .no-data {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        @media (max-width: 1024px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .export-buttons button {
            flex: 1;
            padding: 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .export-buttons button:hover {
            background: #229954;
        }

        .export-buttons button.pdf {
            background: #c0392b;
        }

        .export-buttons button.pdf:hover {
            background: #a93226;
        }

        .resumo-financeiro {
            display: grid;
            gap: 15px;
        }

        .resumo-item {
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }

        .resumo-item.receita {
            background: #d4edda;
            color: #155724;
        }

        .resumo-item.custo {
            background: #cce5ff;
            color: #004085;
        }

        .resumo-item.lucro {
            background: #fff3cd;
            color: #856404;
        }

        .resumo-item.roi {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üí∞ Precifica√ß√£o Simples</h1>
        <p>Sistema inteligente de c√°lculo de pre√ßos</p>
    </div>

    <div class="tabs">
        <button class="tab-button active" onclick="app.mudarAba('produtos')">üì¶ Produtos</button>
        <button class="tab-button" onclick="app.mudarAba('dashboard')">üìä Dashboard</button>
        <button class="tab-button" onclick="app.mudarAba('analytics')">üìà Analytics</button>
    </div>

    <!-- ABA 1: PRODUTOS -->
    <div id="produtos" class="tab-content active">
        <div class="content">
            <div class="card">
                <h2>Adicionar Produto</h2>
                <div id="alert" class="alert"></div>
                <form id="formProduto">
                    <div class="form-group">
                        <label for="custoFixoMensal">Custo Fixo Mensal (R$):</label>
                        <input type="number" id="custoFixoMensal" name="custoFixoMensal" step="0.01" value="250.00" required>
                    </div>

                    <div class="form-group">
                        <label for="nome">Nome do Produto:</label>
                        <input type="text" id="nome" name="nome" required>
                    </div>

                    <div class="form-group">
                        <label for="categoria">Categoria:</label>
                        <input type="text" id="categoria" name="categoria" placeholder="Ex: Perfume, Rel√≥gio" required>
                    </div>

                    <div class="form-group">
                        <label for="precoCusto">Pre√ßo de Custo (R$):</label>
                        <input type="number" id="precoCusto" name="precoCusto" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label for="quantidadeEstimada">Quantidade Estimada:</label>
                        <input type="number" id="quantidadeEstimada" name="quantidadeEstimada" required>
                    </div>

                    <div class="form-group">
                        <label for="margemDesejada">Margem Desejada (%):</label>
                        <input type="number" id="margemDesejada" name="margemDesejada" step="0.01" value="26" required>
                    </div>

                    <div class="form-group">
                        <label for="impostosCustosVariaveis">Impostos + Custos Vari√°veis (%):</label>
                        <input type="number" id="impostosCustosVariaveis" name="impostosCustosVariaveis" step="0.01" value="15" required>
                    </div>

                    <button type="submit">‚ûï Adicionar Produto</button>
                </form>
            </div>

            <div class="card">
                <h2>Produtos Cadastrados</h2>
                <div class="table-wrapper">
                    <table id="tabelaProdutos">
                        <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Qtd Est.</th>
                            <th>Pre√ßo Compra</th>
                            <th>Custo Fixo/Un</th>
                            <th>Custo Total Base</th>
                            <th>Pre√ßo Venda Ideal</th>
                            <th>Margem Contribui√ß√£o</th>
                            <th>Lucro Bruto/Un</th>
                            <th>A√ß√µes</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ABA 2: DASHBOARD -->
    <div id="dashboard" class="tab-content">
        <div class="card">
            <h2>üìä Dashboard Geral</h2>
            <div id="dashboardContent" style="display: none;">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Custo Fixo Mensal</h3>
                        <div class="value" id="dashCustoFixo">R$ 0,00</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Receita Total Mensal</h3>
                        <div class="value" id="dashReceita">R$ 0,00</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Custo Total de Compra</h3>
                        <div class="value" id="dashCustoCompra">R$ 0,00</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Margem de Contribui√ß√£o Total</h3>
                        <div class="value" id="dashMargemTotal">R$ 0,00</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Venda Estimada Mensal</h3>
                        <div class="value" id="dashVendas">0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Margem M√©dia (%)</h3>
                        <div class="value" id="dashMargemMedia">0%</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Lucro Bruto Total</h3>
                        <div class="value" id="dashLucro">R$ 0,00</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Ponto de Equil√≠brio (R$)</h3>
                        <div class="value" id="dashPontoEquilibrio">R$ 0,00</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>ROI Geral (%)</h3>
                        <div class="value" id="dashROI">0%</div>
                    </div>
                    <div class="dashboard-card" style="grid-column: 1 / -1;">
                        <h3>Status</h3>
                        <div class="value status" id="dashStatus">-</div>
                    </div>
                </div>
            </div>
            <div id="dashboardVazio" class="no-data">
                Nenhum produto cadastrado. Adicione produtos na aba "Produtos" para ver o dashboard.
            </div>
        </div>
    </div>

    <!-- ABA 3: ANALYTICS -->
    <div id="analytics" class="tab-content">
        <div class="card">
            <h2>üìà Analytics & Relat√≥rios</h2>

            <div class="export-buttons">
                <button onclick="app.exportarCSV()">üíæ Exportar CSV</button>
                <button class="pdf" onclick="app.exportarTXT()">üìÑ Exportar Relat√≥rio</button>
            </div>

            <div class="chart-row">
                <div class="chart-container">
                    <h3 style="margin-bottom: 20px;">Receita vs Lucro (Mensal)</h3>
                    <canvas id="chartReceitaLucro"></canvas>
                </div>
                <div class="chart-container">
                    <h3 style="margin-bottom: 20px;">Top 5 Produtos (Lucro)</h3>
                    <canvas id="chartTopProdutos"></canvas>
                </div>
            </div>

            <div class="chart-row">
                <div class="chart-container">
                    <h3 style="margin-bottom: 20px;">Distribui√ß√£o por Categoria</h3>
                    <canvas id="chartCategorias"></canvas>
                </div>
                <div class="chart-container">
                    <h3 style="margin-bottom: 20px;">Resumo Financeiro</h3>
                    <div id="resumoFinanceiro" class="resumo-financeiro"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    class ApiService {
        constructor() {
            this.baseUrl = 'https://unpenetrated-overbravely-janae.ngrok-free.dev/api';
            this.headers = {
                'ngrok-skip-browser-warning': '69420',
                'Content-Type': 'application/json'
            };
        }

        async listarProdutos() {
            try {
                const response = await fetch(`${this.baseUrl}/produtos`, {
                    headers: this.headers
                });
                if (!response.ok) throw new Error('Erro ao listar produtos');
                const data = await response.json();
                console.log('Produtos recebidos:', data);
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('Erro na API listarProdutos:', error);
                return [];
            }
        }

        async criar(produto) {
            const response = await fetch(`${this.baseUrl}/produtos`, {
                method: 'POST',
                headers: this.headers,
                body: JSON.stringify(produto),
            });
            if (!response.ok) throw new Error('Erro ao criar produto');
            return response.json();
        }

        async deletar(id) {
            const response = await fetch(`${this.baseUrl}/produtos/${id}`, {
                method: 'DELETE',
                headers: this.headers
            });
            if (!response.ok) throw new Error('Erro ao deletar produto');
        }

        async obterResumo() {
            try {
                const response = await fetch(`${this.baseUrl}/produtos/resumo/consolidado`, {
                    headers: this.headers
                });
                if (!response.ok) throw new Error('Erro ao obter resumo');
                const data = await response.json();
                console.log('Resumo recebido:', data);
                return data;
            } catch (error) {
                console.error('Erro na API obterResumo:', error);
                return null;
            }
        }

        async exportarCSV() {
            const response = await fetch(`${this.baseUrl}/relatorio/csv`, {
                headers: this.headers
            });
            if (!response.ok) throw new Error('Erro ao exportar CSV');
            return response.text();
        }

        async exportarTXT() {
            const response = await fetch(`${this.baseUrl}/relatorio/txt`, {
                headers: this.headers
            });
            if (!response.ok) throw new Error('Erro ao exportar TXT');
            return response.text();
        }
    }

    class App {
        constructor() {
            this.apiService = new ApiService();
            this.produtos = [];
            this.inicializarEventos();
            this.carregarProdutos();
            setInterval(() => this.atualizarDashboard(), 3000);
        }

        inicializarEventos() {
            const form = document.getElementById('formProduto');
            form.addEventListener('submit', (e) => this.handleSubmit(e));
        }

        async handleSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);

            const produto = {
                nome: formData.get('nome'),
                categoria: formData.get('categoria'),
                precoCusto: parseFloat(formData.get('precoCusto')),
                quantidadeEstimada: parseInt(formData.get('quantidadeEstimada')),
                margemDesejada: parseFloat(formData.get('margemDesejada')) / 100,
                impostosCustosVariaveis: parseFloat(formData.get('impostosCustosVariaveis')) / 100,
                custoFixoMensal: parseFloat(formData.get('custoFixoMensal')),
            };

            try {
                console.log('Criando produto:', produto);
                await this.apiService.criar(produto);
                console.log('Produto criado com sucesso!');
                form.reset();
                console.log('Recarregando produtos...');
                await this.carregarProdutos();
                console.log('Produtos recarregados!');
                this.mostrarAlerta('‚úÖ Produto criado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao criar:', error);
                this.mostrarAlerta(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async carregarProdutos() {
            try {
                console.log('Carregando produtos...');
                this.produtos = await this.apiService.listarProdutos();
                console.log('Produtos carregados:', this.produtos);
                this.renderizarTabela();
                await this.atualizarDashboard();
                await this.criarGraficos();
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
            }
        }

        renderizarTabela() {
            const tbody = document.querySelector('#tabelaProdutos tbody');
            tbody.innerHTML = '';

            if (this.produtos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">Nenhum produto cadastrado</td></tr>';
                return;
            }

            this.produtos.forEach((produto) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${produto.nome}</td>
                    <td>${produto.categoria}</td>
                    <td>${produto.quantidadeEstimada}</td>
                    <td>R$ ${produto.precoCusto.toFixed(2)}</td>
                    <td>R$ ${(produto.custoFixoPorUnidade || 0).toFixed(2)}</td>
                    <td>R$ ${(produto.custoTotalBase || 0).toFixed(2)}</td>
                    <td>R$ ${(produto.precoIdeal || 0).toFixed(2)}</td>
                    <td>R$ ${(produto.margemBruta || 0).toFixed(2)}</td>
                    <td>R$ ${(produto.lucroBrutoPorUnidade || 0).toFixed(2)}</td>
                    <td>
                        <button class="btn-expand" onclick="app.expandirDetalhes(${produto.id}, this)">Detalhes</button>
                        <button class="btn-delete" onclick="app.deletarProduto(${produto.id})">Deletar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        expandirDetalhes(id, button) {
            const produto = this.produtos.find(p => p.id === id);
            if (!produto) return;

            const detalhesRow = document.querySelector(`[data-details-id="${id}"]`);

            if (detalhesRow) {
                detalhesRow.remove();
                button.textContent = 'Detalhes';
                return;
            }

            const tr = button.closest('tr');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-details-id', id);
            newRow.innerHTML = `
                <td colspan="10">
                    <div class="details-row">
                        <div class="detail-item">
                            <label>Quantidade Estimada</label>
                            <div class="value">${produto.quantidadeEstimada}</div>
                        </div>
                        <div class="detail-item">
                            <label>Pre√ßo de Compra</label>
                            <div class="value">R$ ${produto.precoCusto.toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Custo Fixo por Unidade</label>
                            <div class="value">R$ ${(produto.custoFixoPorUnidade || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Custo Total Base</label>
                            <div class="value">R$ ${(produto.custoTotalBase || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Pre√ßo de Venda Ideal</label>
                            <div class="value">R$ ${(produto.precoIdeal || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Margem de Contribui√ß√£o</label>
                            <div class="value">R$ ${(produto.margemBruta || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Lucro Bruto por Unidade</label>
                            <div class="value">R$ ${(produto.lucroBrutoPorUnidade || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Lucro Mensal</label>
                            <div class="value">R$ ${(produto.lucroMensal || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Receita Mensal</label>
                            <div class="value">R$ ${(produto.receita || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Margem Desejada</label>
                            <div class="value">${(produto.margemDesejada * 100).toFixed(2)}%</div>
                        </div>
                        <div class="detail-item">
                            <label>Impostos + Custos Vari√°veis</label>
                            <div class="value">${(produto.impostosCustosVariaveis * 100).toFixed(2)}%</div>
                        </div>
                        <div class="detail-item">
                            <label>Custo Fixo Mensal</label>
                            <div class="value">R$ ${produto.custoFixoMensal.toFixed(2)}</div>
                        </div>
                    </div>
                </td>
            `;
            tr.after(newRow);
            button.textContent = 'Recolher';
        }

        async atualizarDashboard() {
            try {
                const resumo = await this.apiService.obterResumo();

                if (!resumo || resumo.status === 'Nenhum produto cadastrado') {
                    document.getElementById('dashboardContent').style.display = 'none';
                    document.getElementById('dashboardVazio').style.display = 'block';
                    return;
                }

                document.getElementById('dashboardContent').style.display = 'block';
                document.getElementById('dashboardVazio').style.display = 'none';

                document.getElementById('dashCustoFixo').textContent = `R$ ${resumo.custoFixoMensal.toFixed(2)}`;
                document.getElementById('dashReceita').textContent = `R$ ${resumo.receitaTotalMensal.toFixed(2)}`;
                document.getElementById('dashCustoCompra').textContent = `R$ ${resumo.custoTotalCompra.toFixed(2)}`;
                document.getElementById('dashMargemTotal').textContent = `R$ ${resumo.margemContribuicaoTotal.toFixed(2)}`;
                document.getElementById('dashVendas').textContent = resumo.vendaEstimada;
                document.getElementById('dashMargemMedia').textContent = `${resumo.margemMediaPercentual.toFixed(2)}%`;
                document.getElementById('dashLucro').textContent = `R$ ${resumo.lucrobrutoTotal.toFixed(2)}`;
                document.getElementById('dashPontoEquilibrio').textContent = `R$ ${resumo.pontoEquilibrioReais.toFixed(2)}`;
                document.getElementById('dashROI').textContent = `${resumo.roiGeral.toFixed(2)}%`;

                const statusElement = document.getElementById('dashStatus');
                statusElement.textContent = resumo.status;
            } catch (error) {
                console.error('Erro ao atualizar dashboard:', error);
            }
        }

        async criarGraficos() {
            if (this.produtos.length === 0) return;

            const resumo = await this.apiService.obterResumo();
            if (!resumo) return;

            this.criarGraficoReceitaLucro(resumo);
            this.criarGraficoTopProdutos();
            this.criarGraficoCategorias();
            this.atualizarResumoFinanceiro(resumo);
        }

        criarGraficoReceitaLucro(resumo) {
            const ctx = document.getElementById('chartReceitaLucro');
            if (!ctx) return;

            if (window.chartReceitaLucro) {
                window.chartReceitaLucro.destroy();
            }

            window.chartReceitaLucro = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Receita Total', 'Lucro Bruto', 'Custo Total'],
                    datasets: [{
                        label: 'Valores (R$)',
                        data: [
                            resumo.receitaTotalMensal.toFixed(2),
                            resumo.lucrobrutoTotal.toFixed(2),
                            resumo.custoTotalCompra.toFixed(2)
                        ],
                        backgroundColor: [
                            '#3498db',
                            '#2ecc71',
                            '#e74c3c'
                        ],
                        borderColor: [
                            '#2980b9',
                            '#27ae60',
                            '#c0392b'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        criarGraficoTopProdutos() {
            const ctx = document.getElementById('chartTopProdutos');
            if (!ctx) return;

            const top5 = [...this.produtos]
                .sort((a, b) => (b.lucroMensal || 0) - (a.lucroMensal || 0))
                .slice(0, 5);

            if (window.chartTopProdutos) {
                window.chartTopProdutos.destroy();
            }

            window.chartTopProdutos = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: top5.map(p => p.nome),
                    datasets: [{
                        label: 'Lucro Mensal (R$)',
                        data: top5.map(p => (p.lucroMensal || 0).toFixed(2)),
                        backgroundColor: [
                            '#3498db',
                            '#2ecc71',
                            '#f39c12',
                            '#e74c3c',
                            '#9b59b6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        criarGraficoCategorias() {
            const ctx = document.getElementById('chartCategorias');
            if (!ctx) return;

            const categorias = {};
            this.produtos.forEach(p => {
                if (!categorias[p.categoria]) {
                    categorias[p.categoria] = 0;
                }
                categorias[p.categoria] += (p.lucroMensal || 0);
            });

            if (window.chartCategorias) {
                window.chartCategorias.destroy();
            }

            window.chartCategorias = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [{
                        data: Object.values(categorias).map(v => v.toFixed(2)),
                        backgroundColor: [
                            '#3498db',
                            '#2ecc71',
                            '#f39c12',
                            '#e74c3c',
                            '#9b59b6',
                            '#1abc9c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        atualizarResumoFinanceiro(resumo) {
            const div = document.getElementById('resumoFinanceiro');
            if (!div) return;

            div.innerHTML = `
                <div class="resumo-item receita">
                    <strong>Receita Total:</strong><br>
                    R$ ${resumo.receitaTotalMensal.toFixed(2)}
                </div>
                <div class="resumo-item custo">
                    <strong>Custo Total:</strong><br>
                    R$ ${resumo.custoTotalCompra.toFixed(2)}
                </div>
                <div class="resumo-item lucro">
                    <strong>Lucro Bruto:</strong><br>
                    R$ ${resumo.lucrobrutoTotal.toFixed(2)}
                </div>
                <div class="resumo-item roi">
                    <strong>ROI:</strong><br>
                    ${resumo.roiGeral.toFixed(2)}%
                </div>
            `;
        }

        async exportarCSV() {
            try {
                const csv = await this.apiService.exportarCSV();
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `relatorio_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                this.mostrarAlerta('‚úÖ CSV exportado com sucesso!', 'success');
            } catch (error) {
                this.mostrarAlerta(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async exportarTXT() {
            try {
                const txt = await this.apiService.exportarTXT();
                const blob = new Blob([txt], { type: 'text/plain;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `relatorio_${new Date().toISOString().split('T')[0]}.txt`;
                link.click();
                this.mostrarAlerta('‚úÖ Relat√≥rio exportado com sucesso!', 'success');
            } catch (error) {
                this.mostrarAlerta(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async deletarProduto(id) {
            if (!confirm('Tem certeza que deseja deletar este produto?')) return;

            try {
                await this.apiService.deletar(id);
                await this.carregarProdutos();
                this.mostrarAlerta('‚úÖ Produto deletado com sucesso!', 'success');
            } catch (error) {
                this.mostrarAlerta(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        mostrarAlerta(mensagem, tipo) {
            const alert = document.getElementById('alert');
            alert.textContent = mensagem;
            alert.className = `alert ${tipo}`;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        mudarAba(abaName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(abaName).classList.add('active');
            event.target.classList.add('active');
        }
    }

    let app;
    document.addEventListener('DOMContentLoaded', () => {
        app = new App();
    });
</script>
</body>
</html>
